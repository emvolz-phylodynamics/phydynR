<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating transmission rate using the SIR model • phydynR</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating transmission rate using the SIR model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">phydynR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/phydynR.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/sir_model.html">Estimating transmission rate using the SIR model</a></li>
    <li><a class="dropdown-item" href="../articles/HIV_epidemics.html">Estimating HIV transmission rates</a></li>
    <li><a class="dropdown-item" href="../articles/simulate_genealogies.html">Simulating genealogies with an epidemiological coalescent model</a></li>
    <li><a class="dropdown-item" href="../articles/SenegalHIVmodel.html">HIV Senegal Model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/emvolz-phylodynamics/phydynR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimating transmission rate using the SIR model</h1>
                        <h4 data-toc-skip class="author">Erik Volz</h4>
            
            <h4 data-toc-skip class="date">2025-02-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/emvolz-phylodynamics/phydynR/blob/HEAD/vignettes/sir_model.Rmd" class="external-link"><code>vignettes/sir_model.Rmd</code></a></small>
      <div class="d-none name"><code>sir_model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette will demonstrate how to use coalescent models as described
in <span class="citation">(Volz 2012)</span> to estimate transmission rate parameters given a pathogen genealogy.</p>
</div>
<div class="section level2">
<h2 id="basic-requirements">Basic requirements<a class="anchor" aria-label="anchor" href="#basic-requirements"></a>
</h2>
<p>This vignette assumes that you have the following packages already installed:</p>
<ul>
<li>rjson: Converts R objects into JSON objects and vice-versa.</li>
<li>
<a href="https://github.com/emvolz-phylodynamics/phydynR" class="external-link">phydynR</a>: implements the
coalescent simulation and likelihood function for phylodynamics analysis</li>
<li>
<a href="https://ggplot2.tidyverse.org/" class="external-link">ggplot2</a>: functions to plot the demographic
process.</li>
</ul>
<div class="section level3">
<h3 id="load-the-necessary-packages">Load the necessary packages:<a class="anchor" aria-label="anchor" href="#load-the-necessary-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://emvolz-phylodynamics.github.io/phydynR/">phydynR</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexcb/rjson" class="external-link">rjson</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/bbmle" class="external-link">bbmle</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>Suppose an epidemic occurs according to a density-dependent susceptible-
infected-recovered (SIR) process, and a given infected individual generates a
new infection at the rate <span class="math inline">\(\beta SI\)</span>, where <span class="math inline">\(S\)</span> is the number susceptible and <span class="math inline">\(\beta\)</span>
is the transmission rate. Furthermore, infected individuals will be removed from
the population at per capita rate <span class="math inline">\(\gamma\)</span>. At a single point in time,
a random sample of <span class="math inline">\(n = 75\)</span> infected individuals is taken and the genealogy is
reconstructed from the history of transmissions. We have simulated such a dataset
using MASTER 1.10 <span class="citation">(Vaughan and Drummond 2013)</span>, which can be loaded by</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">read.tree</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sirModel0.nwk"</span>, package <span class="op">=</span> <span class="st">"phydynR"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And, the epidemic trajectory information can be loaded by</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epidata</span> <span class="op">&lt;-</span> <span class="fu">rjson</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span>file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sirModel0.json"</span>, package <span class="op">=</span> <span class="st">"phydynR"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The true parameter values are given in table 1. The file used to simulate the data
with MASTER can be viewed by or directly openning the xml file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/file.show.html" class="external-link">file.show</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sirModel0.xml"</span>, package <span class="op">=</span> <span class="st">"phydynR"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<table class="table table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:table1">Table 1: </span>Parameter symbols and values
</caption>
<thead><tr>
<th style="text-align:left;">
Parameter
</th>
<th style="text-align:left;">
Symbol
</th>
<th style="text-align:left;">
Values
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Duration infection
</td>
<td style="text-align:left;">
<span class="math inline">\(1/\gamma\)</span>
</td>
<td style="text-align:left;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Transmission rate
</td>
<td style="text-align:left;">
<span class="math inline">\(\beta\)</span>
</td>
<td style="text-align:left;">
2.0002e-4
</td>
</tr>
<tr>
<td style="text-align:left;">
Population size
</td>
<td style="text-align:left;">
<span class="math inline">\(S(0)\)</span>
</td>
<td style="text-align:left;">
9999
</td>
</tr>
<tr>
<td style="text-align:left;">
Initial num infected
</td>
<td style="text-align:left;">
<span class="math inline">\(I(0)\)</span>
</td>
<td style="text-align:left;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Time of sampling
</td>
<td style="text-align:left;">
<span class="math inline">\(T\)</span>
</td>
<td style="text-align:left;">
12
</td>
</tr>
</tbody>
</table>
<p>We will fit a simple ordinary differential equation (ODE) model to the genealogy:</p>
<p><span class="math inline">\(\dot{S} = -\beta SI\)</span></p>
<p><span class="math inline">\(\dot{I} = \beta SI -\gamma I\)</span></p>
<p>Relevant parameters of the system are the transmission rate <span class="math inline">\(\beta\)</span>,
recovery rate <span class="math inline">\(\gamma\)</span>, initial population size <span class="math inline">\(S(0)\)</span> and initial number
infected <span class="math inline">\(I(0)\)</span>. Not all parameters are identifiable from these data, so we will
assume prior knowledge of <span class="math inline">\(S(0)\)</span> and <span class="math inline">\(\gamma\)</span> and focus on estimating <span class="math inline">\(\beta\)</span>
and the nuisance parameter <span class="math inline">\(I(0)\)</span>. Note that an imprecise estimate of <span class="math inline">\(S(0)\)</span>
is also possible.</p>
<p>Create a list to store the true parameter values:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">parms_truth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> beta <span class="op">=</span> <span class="fl">0.00020002</span>, </span>
<span>                     gamma <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                     S0 <span class="op">=</span> <span class="fl">9999</span>, </span>
<span>                     t0 <span class="op">=</span> <span class="fl">0</span> <span class="op">)</span></span></code></pre></div>
<p>Note that the true value of R0 is <span class="math inline">\(\beta S(0)/\gamma = 2\)</span>.</p>
<p>And, create a tree with dated tips and internal nodes:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sampleTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sampleTimes</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span><span class="va">bdt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DatedTree.html">DatedTree</a></span><span class="op">(</span> phylo <span class="op">=</span> <span class="va">tree</span>, </span>
<span>                  sampleTimes <span class="op">=</span> <span class="va">sampleTimes</span><span class="op">)</span></span>
<span><span class="va">bdt</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Phylogenetic tree with 75 tips and 74 internal nodes.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tip labels:</span></span>
<span><span class="co">#&gt;   24, 7, 36, 75, 52, 38, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rooted; includes branch length(s).</span></span></code></pre></div>
<p>Note that the vector of sample times must have names corresponding to the
taxon labels in tree.</p>
<p>In order to fit this model, we need to express the equations in a canonical
format:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> I <span class="op">=</span> <span class="st">"beta * S * I"</span> <span class="op">)</span></span>
<span><span class="va">deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> I <span class="op">=</span> <span class="st">"gamma * I"</span> <span class="op">)</span></span>
<span><span class="va">nonDemeDynamics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="st">"-beta * S * I"</span><span class="op">)</span></span></code></pre></div>
<p>The births vector gives the total rate that all infected generate new infections
and deaths gives the rate that lineages are terminated.
The nonDemeDynamics vector gives the equations for state variables that are not
directly involved in the genealogy (e.g. because a pathogen never occupies a
susceptible host by definition).
Each element of the vectors is a string that will be parsed as R code and
evaluated, so it is important to write it exactly as you would if you were
solving the equations in R.
Also note that the object parms is accessible to these equations, which is a
list of parameters - this may include parameters to be estimated. Also
note that we must give names to the vectors, and these names must correspond
to the names of the demes.</p>
<p>We will use these initial conditions</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># initial number of I and S</span></span>
<span><span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">1</span>, S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">parms_truth</span><span class="op">$</span><span class="va">S0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># initial t0 (time of origin of the process)</span></span>
<span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="va">bdt</span><span class="op">$</span><span class="va">maxSampleTime</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bdt</span><span class="op">$</span><span class="va">heights</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span></code></pre></div>
<p>The time of origin t0 is chosen somewhat arbitrarily, but should occur before
the root of the tree.</p>
</div>
<div class="section level3">
<h3 id="the-demographic-model">The demographic model<a class="anchor" aria-label="anchor" href="#the-demographic-model"></a>
</h3>
<p>After setting up all the components of the mathematical model, we can build the
demographic process using the function <code>build.demographic.process</code> from the <code>phydynR</code>
package. The <code>dm</code> output can be used as input to coalescent models for the
calculation of the likelihood.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build.demographic.process.html">build.demographic.process</a></span><span class="op">(</span>births <span class="op">=</span> <span class="va">births</span>,</span>
<span>                                nonDemeDynamics <span class="op">=</span> <span class="va">nonDemeDynamics</span>,</span>
<span>                                deaths <span class="op">=</span> <span class="va">deaths</span>,</span>
<span>                                parameterNames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parms_truth</span><span class="op">)</span>,</span>
<span>                                rcpp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                sde <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Wed Feb 12 14:33:44 2025 Compiling model..."</span></span>
<span><span class="co">#&gt; [1] "Wed Feb 12 14:33:49 2025 Model complete"</span></span></code></pre></div>
<p>Now we can calculate the likelihood of the tree and assess how long it takes:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">phydynR</span><span class="fu">::</span><span class="fu"><a href="../reference/colik.html">colik</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">bdt</span>,</span>
<span>                                       theta <span class="op">=</span> <span class="va">parms_truth</span>,</span>
<span>                                       demographic.process.model <span class="op">=</span> <span class="va">dm</span>,</span>
<span>                                       x0 <span class="op">=</span> <span class="va">x0</span>,</span>
<span>                                       t0 <span class="op">=</span> <span class="va">t0</span>,</span>
<span>                                       res <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                       integrationMethod <span class="op">=</span> <span class="st">"rk4"</span><span class="op">)</span></span>
<span>                        <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -378.142</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.326   0.009   0.335</span></span></code></pre></div>
<p>Note that changing the <em>integrationMethod</em> (choose “euler”), <em>maxHeight</em>
(only fit to part of the tree) and <em>res</em> (set to a smaller value) options
can dramatically speed up the calculation at the cost of some accuracy.</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h2>
<p>We can fit the model using maximum likelihood with the <code>bbmle</code> or <code>stats4</code>
R packages.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lnbeta</span>, <span class="va">lnI0</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">lnbeta</span><span class="op">)</span></span>
<span>  <span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">lnI0</span><span class="op">)</span></span>
<span>  <span class="va">parms</span> <span class="op">&lt;-</span> <span class="va">parms_truth</span></span>
<span>  <span class="va">parms</span><span class="op">$</span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">beta</span></span>
<span>  <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">I0</span><span class="op">)</span>, S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">parms</span><span class="op">$</span><span class="va">S0</span><span class="op">)</span> <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">mll</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu">phydynR</span><span class="fu">::</span><span class="fu"><a href="../reference/colik.html">colik</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">bdt</span>,</span>
<span>                         theta <span class="op">=</span> <span class="va">parms_truth</span>,</span>
<span>                         demographic.process.model <span class="op">=</span> <span class="va">dm</span>,</span>
<span>                         x0 <span class="op">=</span> <span class="va">x0</span>,</span>
<span>                         t0 <span class="op">=</span> <span class="va">t0</span>,</span>
<span>                         res <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                         integrationMethod <span class="op">=</span> <span class="st">"rk4"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">mll</span>, <span class="va">beta</span>, <span class="va">I0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mll</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that this uses log-transformation for variables that must be positive (like
rates and population sizes).
We can then fit the model by running</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/bbmle/man/mle2.html" class="external-link">mle2</a></span><span class="op">(</span><span class="va">obj_fun</span>,</span>
<span>            start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lnbeta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">parms_truth</span><span class="op">$</span><span class="va">beta</span> <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span>, lnI0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            method <span class="op">=</span> <span class="st">"Nelder-Mead"</span>,</span>
<span>            optimizer <span class="op">=</span> <span class="st">"optim"</span>,</span>
<span>            control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">6</span>, reltol<span class="op">=</span><span class="fl">1e-8</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that we are starting the optimizer far from the true parameter values. If
fitting a model to real data, it is recommended to try many different starting
conditions over a large range of values. The optimizer would take a few minutes
to run, so instead we will load the results:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sirModel0-fit.RData"</span>, package<span class="op">=</span><span class="st">"phydynR"</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -145.7974</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'log Lik.' 74.89871 (df=2)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;     lnbeta       lnI0 </span></span>
<span><span class="co">#&gt; -8.4748155  0.1351695</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       lnbeta         lnI0 </span></span>
<span><span class="co">#&gt; 0.0002086577 1.1447308446</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span><span class="st">"lnbeta"</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="va">parms_truth</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="co">#&gt;       lnbeta </span></span>
<span><span class="co">#&gt; 8.637689e-06</span></span>
<span></span>
<span><span class="co"># how biased is the estimate?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span><span class="st">"lnbeta"</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="va">parms_truth</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="co">#&gt;       lnbeta </span></span>
<span><span class="co">#&gt; 8.637689e-06</span></span></code></pre></div>
<p>We can compare the fitted model to the true number of infected through
time, which is shown in Figure <a href="#fig:figure1">1</a>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span><span class="st">"lnbeta"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span><span class="st">"lnI0"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">parms</span> <span class="op">&lt;-</span> <span class="va">parms_truth</span></span>
<span><span class="va">parms</span><span class="op">$</span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">beta</span></span>
<span><span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">I0</span><span class="op">)</span>, S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">parms</span><span class="op">$</span><span class="va">S0</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">o</span> <span class="op">&lt;-</span> <span class="fu">dm</span><span class="op">(</span><span class="va">parms</span>,</span>
<span>        <span class="va">x0</span>,</span>
<span>        <span class="va">t0</span>,</span>
<span>        t1 <span class="op">=</span> <span class="va">bdt</span><span class="op">$</span><span class="va">maxSampleTime</span>,</span>
<span>        res <span class="op">=</span> <span class="fl">1e3</span>, </span>
<span>        integrationMethod<span class="op">=</span><span class="st">'rk4'</span><span class="op">)</span></span>
<span><span class="va">o</span> <span class="op">&lt;-</span> <span class="va">o</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">otruth</span> <span class="op">&lt;-</span> <span class="fu">dm</span><span class="op">(</span><span class="va">parms_truth</span>,</span>
<span>             <span class="va">x0</span>,</span>
<span>             <span class="va">t0</span>, </span>
<span>             t1 <span class="op">=</span> <span class="va">bdt</span><span class="op">$</span><span class="va">maxSampleTime</span>,</span>
<span>             res <span class="op">=</span> <span class="fl">1e3</span>, </span>
<span>             integrationMethod<span class="op">=</span><span class="st">'rk4'</span><span class="op">)</span></span>
<span><span class="va">otruth</span> <span class="op">&lt;-</span> <span class="va">otruth</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">rdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">epidata</span><span class="op">$</span><span class="va">t</span>, I <span class="op">=</span> <span class="va">epidata</span><span class="op">$</span><span class="va">I</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">I</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">o</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">I</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'blue'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">otruth</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">I</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Number of infected"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:figure1"></span>
<img src="sir_model_files/figure-html/figure1-1.png" alt="The actual (black) and estimated (red) number of infections through time. The blue line shows the SIR model prediction under the true parameter values."><p class="caption">
Figure 1: The actual (black) and estimated (red) number of infections through time. The blue line shows the SIR model prediction under the true parameter values.
</p>
</div>
<p>We can calculate a confidence interval for the transmission rate using likelihood
profiles:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">profbeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/profile.html" class="external-link">profile</a></span><span class="op">(</span><span class="va">fit</span>, </span>
<span>                    which <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                    std.err <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    trace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    tol.newmin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>This takes a few minutes, so we will load the results:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/sirModel0-profbeta.RData"</span>, package <span class="op">=</span> <span class="st">"phydynR"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can see that the confidence interval covers the true value:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span> <span class="va">profbeta</span> <span class="op">)</span> <span class="op">)</span>, TrueVal <span class="op">=</span> <span class="va">parms_truth</span><span class="op">$</span><span class="va">beta</span> <span class="op">)</span></span>
<span><span class="co">#&gt;        2.5 %       97.5 %      TrueVal </span></span>
<span><span class="co">#&gt; 0.0001901721 0.0002282366 0.0002000200</span></span></code></pre></div>
<p>And, we can visualize the profile (Figure 2).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">profbeta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span> v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="va">parms_truth</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span> , col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:figure2"></span>
<img src="sir_model_files/figure-html/figure2-1.png" alt="Likelihood profile for the transmission rate $\beta$ with confidence levels. The true parameter value is indicated by the vertical red line."><p class="caption">
Figure 2: Likelihood profile for the transmission rate <span class="math inline">\(\beta\)</span> with confidence levels. The true parameter value is indicated by the vertical red line.
</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Vaughan2013" class="csl-entry">
Vaughan, Timothy G., and Alexei J. Drummond. 2013. <span>“<span class="nocase">A Stochastic Simulator of Birth–Death Master Equations with Application to Phylodynamics</span>.”</span> <em>Molecular Biology and Evolution</em> 30 (6): 1480–93. <a href="https://doi.org/10.1093/molbev/mst057" class="external-link">https://doi.org/10.1093/molbev/mst057</a>.
</div>
<div id="ref-Volz2012" class="csl-entry">
Volz, Erik M. 2012. <span>“<span class="nocase">Complex Population Dynamics and the Coalescent Under Neutrality</span>.”</span> <em>Genetics</em> 190 (1): 187–201. <a href="https://doi.org/10.1534/genetics.111.134627" class="external-link">https://doi.org/10.1534/genetics.111.134627</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Website developed by <a href="https://thednainus.wordpress.com/me/" class="external-link">Fabricia F. Nascimento</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
