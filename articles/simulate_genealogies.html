<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulating genealogies with an epidemiological coalescent model • phydynR</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating genealogies with an epidemiological coalescent model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">phydynR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/phydynR.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/sir_model.html">Estimating transmission rate using the SIR model</a></li>
    <li><a class="dropdown-item" href="../articles/HIV_epidemics.html">Estimating HIV transmission rates</a></li>
    <li><a class="dropdown-item" href="../articles/simulate_genealogies.html">Simulating genealogies with an epidemiological coalescent model</a></li>
    <li><a class="dropdown-item" href="../articles/SenegalHIVmodel.html">HIV Senegal Model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/emvolz-phylodynamics/phydynR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulating genealogies with an epidemiological coalescent model</h1>
                        <h4 data-toc-skip class="author">Erik Volz</h4>
            
            <h4 data-toc-skip class="date">2025-05-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/emvolz-phylodynamics/phydynR/blob/master/vignettes/simulate_genealogies.Rmd" class="external-link"><code>vignettes/simulate_genealogies.Rmd</code></a></small>
      <div class="d-none name"><code>simulate_genealogies.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette will demonstrate how to build models with phydynR and simulate
genealogies using the structured coalescent. We will use simple deterministic
and stochastic HIV models where infected hosts progress through several stages
of infection characterized by different transmission rates.</p>
</div>
<div class="section level2">
<h2 id="requirements">Requirements<a class="anchor" aria-label="anchor" href="#requirements"></a>
</h2>
<p>This tutorial assumes you have the following R packages already installed in
your computer.</p>
<ul>
<li>
<a href="https://github.com/emvolz-phylodynamics/phydynR" class="external-link">phydynR</a>: implements the coalescent simulation and likelihood function for phylodynamic analyses.</li>
</ul>
<div class="section level3">
<h3 id="load-the-r-packages">Load the R packages<a class="anchor" aria-label="anchor" href="#load-the-r-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://emvolz-phylodynamics.github.io/phydynR/">phydynR</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-epidemiological-model">The epidemiological model<a class="anchor" aria-label="anchor" href="#the-epidemiological-model"></a>
</h2>
<p>First consider a very simple model of an HIV epidemic using ordinary differential equations (ODEs). In this model, the infectious period will be broken into
three stages of different average duration and with different transmission rates.
The first stage, early HIV infection (EHI) is short (average duration <span class="math inline">\(1/\gamma_0 = 1\)</span>
year), but has high transmission rate <span class="math inline">\(\beta_0\)</span>. The second stage, chronic HIV infection, is long (average duration <span class="math inline">\(1/\gamma_1 = 7\)</span> years), and has small
transmission rate.
The last stage, AIDS, lasts <span class="math inline">\(1/\gamma_2 = 2\)</span> years on average and has an intermediate
transmission rate. There are births into the susceptible state at rate <span class="math inline">\(bN\)</span> where
<span class="math inline">\(N = S+I_0+I_1+I_2\)</span>. And there is mortality due to natural causes from all states
at rate <span class="math inline">\(\mu\)</span>. The parameter values are listed in Table <a href="#tab:table1">1</a>. The model equations are as follows:</p>
<p><span class="math inline">\(\dot{S} = bN − \mu S − (\beta_0I_0 + \beta_1I_1 + \beta_2I_2)S/N\)</span></p>
<p><span class="math inline">\(\dot{I_0} = (\beta_0I_0 + \beta_1I_1 + \beta_2I_2)S/N − (\mu + \gamma_0)I_0\)</span></p>
<p><span class="math inline">\(\dot{I_1} = \gamma_0I_0 − (\mu + \gamma_1)I_1\)</span></p>
<p><span class="math inline">\(\dot{I_2} = \gamma_1I_1 − (\mu + \gamma_2)I_2\)</span></p>
<table class="table table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:table1">Table 1: </span>Parameter symbols and values
</caption>
<thead><tr>
<th style="text-align:left;">
Parameter
</th>
<th style="text-align:left;">
Symbol
</th>
<th style="text-align:left;">
Values
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Duration EHI
</td>
<td style="text-align:left;">
<span class="math inline">\(1/\gamma_0\)</span>
</td>
<td style="text-align:left;">
1 year
</td>
</tr>
<tr>
<td style="text-align:left;">
Duration chronic
</td>
<td style="text-align:left;">
<span class="math inline">\(1/\gamma_1\)</span>
</td>
<td style="text-align:left;">
7 years
</td>
</tr>
<tr>
<td style="text-align:left;">
Duration AIDS
</td>
<td style="text-align:left;">
<span class="math inline">\(1/\gamma_2\)</span>
</td>
<td style="text-align:left;">
2 years
</td>
</tr>
<tr>
<td style="text-align:left;">
Birth rate
</td>
<td style="text-align:left;">
<span class="math inline">\(b\)</span>
</td>
<td style="text-align:left;">
0.036
</td>
</tr>
<tr>
<td style="text-align:left;">
Natural death rate
</td>
<td style="text-align:left;">
<span class="math inline">\(\mu\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(1/30\)</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
EHI transmission rate
</td>
<td style="text-align:left;">
<span class="math inline">\(\beta_0\)</span>
</td>
<td style="text-align:left;">
1.2
</td>
</tr>
<tr>
<td style="text-align:left;">
Chronic transmission rate
</td>
<td style="text-align:left;">
<span class="math inline">\(\beta_1\)</span>
</td>
<td style="text-align:left;">
0.03
</td>
</tr>
<tr>
<td style="text-align:left;">
AIDS transmission rate
</td>
<td style="text-align:left;">
<span class="math inline">\(\beta_2\)</span>
</td>
<td style="text-align:left;">
0.09
</td>
</tr>
<tr>
<td style="text-align:left;">
Initial number of susceptibles
</td>
<td style="text-align:left;">
<span class="math inline">\(S(0)\)</span>
</td>
<td style="text-align:left;">
3000
</td>
</tr>
</tbody>
</table>
<p>Now we need to build this model in a format that can be understood by the
phydynR package and used to simulate trees. To do this, we will use the
<em>build.demographic.process</em> function. We first need to express the equations in
a canonical format. According to this format, we will tally birth and migration
events between demes. In our example, the deme corresponds to the stage of
infection that an infected host can be in, so we will refer the demes with the
following names:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">INFECTEDNAMES</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'I0'</span>, <span class="st">'I1'</span>, <span class="st">'I2'</span><span class="op">)</span></span></code></pre></div>
<p>There are <span class="math inline">\(m = 3\)</span> demes in this model, so the birth events between demes
needs to be expressed with a 3 × 3 matrix F. The element <span class="math inline">\(F_kl\)</span> represents the
rate of transmissions by a host in deme <span class="math inline">\(k\)</span> to a host in deme <span class="math inline">\(l\)</span>. In our example,
this is the following:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta0 * S * I0 / (S + I0 + I1 + I2)'</span>, <span class="st">'0'</span>, <span class="st">'0'</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta1 * S * I1 / (S + I0 + I1 + I2)'</span>, <span class="st">'0'</span>, <span class="st">'0'</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta2 * S * I2 / (S + I0 + I1 + I2)'</span>, <span class="st">'0'</span>, <span class="st">'0'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">births</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">births</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">INFECTEDNAMES</span></span></code></pre></div>
<p>Each element of the matrix is a string that will be parsed as C++ code and
evaluated using the Rcpp package, so it is important to write it exactly as
you would if you were solving the equations with the C++. In this case, the
parameters (beta, gamma, etc) are automatically made available. This is the
recommended way to write the model, since after compilation, simulation of the
model will be very fast. Alternatively, we express the equations as R expressions,
in which case the parameters will be available as a list called <code>parms</code>.
For example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># births &lt;- rbind(c('parms$beta0 * S * I0 / (S + I0 + I1 + I2)', '0', '0'),</span></span>
<span><span class="co">#                 c('parms$beta1 * S * I1 / (S + I0 + I1 + I2)', '0', '0'),</span></span>
<span><span class="co">#                 c('parms$beta2 * S * I2 / (S + I0 + I1 + I2)', '0', '0'))</span></span></code></pre></div>
<p>Note that there are zero rates in the 2nd and third columns, since all new infected
hosts start out in the first stage of infection (EHI). Also note that we must give
row and column names to the matrix, and these names must correspond to the
names of the demes.
Similarly, we must create a matrix of migrations:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">migrations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'0'</span>, <span class="st">'gamma0 * I0'</span>, <span class="st">'0'</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'0'</span>, <span class="st">'0'</span>, <span class="st">'gamma1 * I1'</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'0'</span>, <span class="st">'0'</span>, <span class="st">'0'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">migrations</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">migrations</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">INFECTEDNAMES</span></span></code></pre></div>
<p>Note that this matrix tallys the stage progression from EHI to chronic and from
chronic to AIDS.
We must also write a vector of expressions for events that terminate a
lineage – In this model, this occurs due to natural or AIDS related mortality:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mu * I0'</span>,</span>
<span>            <span class="st">'mu * I1'</span>,</span>
<span>            <span class="st">'mu * I2 + gamma2 * I2'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">INFECTEDNAMES</span></span></code></pre></div>
<p>Finally, we must write a vector of rates for state variables that do not
correspond to demes in the coalescent model. In our example, there is only one
such variable - the number of susceptibles:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nonDemeDynamics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> S <span class="op">=</span> <span class="st">'-mu * S + mu * (S + I0 + I1 + I2) - S * (beta0 * I0 + beta1 * I1 + beta2 * I2) / (S + I0 + I1 + I2)'</span><span class="op">)</span></span></code></pre></div>
<p>Note well that in all cases, the expression or equation must have the
corresponding name of the state variable.
Now we can construct the demographic process:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demo.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build.demographic.process.html">build.demographic.process</a></span><span class="op">(</span><span class="va">births</span>,</span>
<span>                                        <span class="va">nonDemeDynamics</span>,</span>
<span>                                        migrations <span class="op">=</span> <span class="va">migrations</span>,</span>
<span>                                        deaths <span class="op">=</span> <span class="va">deaths</span>,</span>
<span>                                        parameterNames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'beta0'</span>, <span class="st">'beta1'</span>,</span>
<span>                                                           <span class="st">'beta2'</span>, <span class="st">'gamma0'</span>,</span>
<span>                                                           <span class="st">'gamma1'</span>, <span class="st">'gamma2'</span>,</span>
<span>                                                           <span class="st">'mu'</span><span class="op">)</span>,</span>
<span>                                        rcpp <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                        sde <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Thu May 15 14:34:20 2025 Compiling model..."</span></span>
<span><span class="co">#&gt; [1] "Thu May 15 14:34:29 2025 Model complete"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">demo.model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "demographic.process" "function"</span></span></code></pre></div>
<p>This creates the model (“demo.model”) by parsing the equations provided in
births, migrations, etc. Note also that we must provide the names of parameters
that will be needed when compiling the model. Two options allow the user to
customize the type of model that is created:</p>
<ul>
<li><p><em>rcpp</em>: If TRUE, the equations are interpreted as C++ code and compiled
using the Rcpp and inline packages. Compilation is slow, but simulating
the model will be much faster. If FALSE, the equations are interpreted
as R expressions. There is no pre-compilation step, but simulation will
be much slower. This approach has some added flexibility, since nonscalar
parameters (even other R functions) can be made available to the
equations in the parms object.</p></li>
<li><p><em>sde</em>: If TRUE, the model will treat the equations as rates within a system of
stochastic differential equations which are solved using the Euler method.
If FALSE, the equations are treated as ODEs and solved using the deSolve package.</p></li>
</ul>
<p>Now we can simulate the demographic process using</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="co"># demo.model(theta, x0, t0, t1, res = 1e3, integrationMethod = 'adams')</span></span></code></pre></div>
<ul>
<li>
<em>theta</em> is a named vector of all parameters</li>
<li>
<em>x0</em> is a named vector of the initial conditions, e.g. I0, I1, I2 and S</li>
<li>
<em>t0</em> and <em>t1</em> are scalar times at which the process is initiated and terminated</li>
<li>
<em>res</em> provides the time resolution of the process, and also corresponds to
the timestep if solving SDEs. Larger values will generally provide a more
accurate approximation, but will be slower</li>
<li>If solving ODEs, the <em>integrationMethod</em> parameter selects the method
used by the deSolve package.</li>
</ul>
<p>Note well that an alternative to using the <em>build.demographic.process</em>
function would be to manually construct the demo.model function. This may
be a good alternative if the model is highly complex or to optimize simulation
time.
The return value of this function should be a list with four elements:</p>
<ol style="list-style-type: decimal">
<li>A length <span class="math inline">\(m\)</span> vector giving the time of each simulated output</li>
<li>A list of length res; each element should be an <span class="math inline">\(m × m\)</span> matrix with computed
birth rates corresponding to each element in times</li>
<li>A list of length <em>res</em>; each element should be an <span class="math inline">\(m × m\)</span> matrix with computed
migration rates</li>
<li>A list of length <em>res</em>; each element should be a length <span class="math inline">\(m\)</span> vector of population
size within each deme.</li>
</ol>
<p>Let’s pick some parameters and initial conditions:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>gamma0 <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           gamma1 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">7</span>,</span>
<span>           gamma2 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span>,</span>
<span>           mu <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">30</span>,</span>
<span>           beta0 <span class="op">=</span> <span class="fl">12.</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>           beta1<span class="op">=</span><span class="fl">3.</span><span class="op">/</span><span class="fl">100</span>,</span>
<span>           beta2<span class="op">=</span><span class="fl">9.</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">999</span>, I0 <span class="op">=</span> <span class="fl">1</span>, I1 <span class="op">=</span> <span class="fl">0.1</span>, I2 <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p>Note that the first stage of infection has a much higher transmission rate than
subsequent stages.
We can easily visualize the model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/show.demographic.process.html">show.demographic.process</a></span><span class="op">(</span><span class="va">demo.model</span>, </span>
<span>                         <span class="va">theta</span>, </span>
<span>                         <span class="va">x0</span>, </span>
<span>                         <span class="va">t0</span>, </span>
<span>                         <span class="va">t1</span>, </span>
<span>                         legend_position <span class="op">=</span> <span class="st">"topright"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_genealogies_files/figure-html/unnamed-chunk-12-1.png"><!-- --></p>
<p>Additional graphical parameters may be passed to the plot function.</p>
<p>Now to simulate the tree, we must further specify the time that each lineage
is sampled, and the state of the lineage at time of sampling. Let’s create a
vector of uniformly spaced sample times:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">sampleTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">25</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span></code></pre></div>
<p>The states of the lineages are specified in the form of a <span class="math inline">\(n × m\)</span> matrix, with
element <span class="math inline">\((i,j)\)</span> corresponding to the probability that lineage <span class="math inline">\(i\)</span> is in deme <span class="math inline">\(j\)</span>
when sampled. Let’s construct such a matrix using multinomial sampling, so that
most samples have chronic infection, and a few are sampled in the first stage:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampleStates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span> <span class="va">n</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.9</span>, <span class="fl">0.075</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sampleStates</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,]    0    1    0</span></span>
<span><span class="co">#&gt; [2,]    0    1    0</span></span>
<span><span class="co">#&gt; [3,]    0    1    0</span></span>
<span><span class="co">#&gt; [4,]    0    1    0</span></span>
<span><span class="co">#&gt; [5,]    0    1    0</span></span>
<span><span class="co">#&gt; [6,]    0    1    0</span></span></code></pre></div>
<p>Now we can simulate the tree:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.co.tree.html">sim.co.tree</a></span> <span class="op">(</span><span class="va">theta</span>, </span>
<span>                     <span class="va">demo.model</span>, </span>
<span>                     <span class="va">x0</span>, </span>
<span>                     <span class="va">t0</span>, </span>
<span>                     <span class="va">sampleTimes</span>, </span>
<span>                     <span class="va">sampleStates</span>, </span>
<span>                     res <span class="op">=</span> <span class="fl">1e3</span><span class="op">)</span></span>
<span><span class="va">tree</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Phylogenetic tree with 100 tips and 99 internal nodes.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tip labels:</span></span>
<span><span class="co">#&gt;   simt_4, simt_71, simt_6, simt_63, simt_74, simt_61, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rooted; includes branch length(s).</span></span></code></pre></div>
<p>The return value is a <code>DatedTree</code> object, which is derived from <code><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">ape::phylo</a></code>.
Consequently, all of the convenience functions for <code><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">ape::phylo</a></code> also work:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the phylogenetic tree</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/plot.phylo.html" class="external-link">plot.phylo</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_genealogies_files/figure-html/unnamed-chunk-16-1.png"><!-- --></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Plot lineages through time from a phylogenetic tree</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/ltt.plot.html" class="external-link">ltt.plot</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_genealogies_files/figure-html/unnamed-chunk-16-2.png"><!-- --></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Website developed by <a href="https://thednainus.wordpress.com/me/" class="external-link">Fabricia F. Nascimento</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
