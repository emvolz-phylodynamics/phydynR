<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>HIV Senegal Model • phydynR</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="HIV Senegal Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">phydynR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/phydynR.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/sir_model.html">Estimating transmission rate using the SIR model</a></li>
    <li><a class="dropdown-item" href="../articles/HIV_epidemics.html">Estimating HIV transmission rates</a></li>
    <li><a class="dropdown-item" href="../articles/simulate_genealogies.html">Simulating genealogies with an epidemiological coalescent model</a></li>
    <li><a class="dropdown-item" href="../articles/SenegalHIVmodel.html">HIV Senegal Model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/emvolz-phylodynamics/phydynR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>HIV Senegal Model</h1>
                        <h4 data-toc-skip class="author">Fabricia F. Nascimento</h4>
            
            <h4 data-toc-skip class="date">2024-10-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/emvolz-phylodynamics/phydynR/blob/HEAD/vignettes/SenegalHIVmodel.Rmd" class="external-link"><code>vignettes/SenegalHIVmodel.Rmd</code></a></small>
      <div class="d-none name"><code>SenegalHIVmodel.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette will demonstrate how we estimated transmission rates using
HIV genetic sequences from Senegal. This also provides a guidance on how analysis
described in <a href="https://www.sciencedirect.com/science/article/pii/S1755436519300660" class="external-link">Nascimento <em>et al</em>. 2020</a> was
carried out.We analysed HIV-1 sequences from subtypes B, C and 02_AG.</p>
<p>Here we will provide a snapshot of these analyses.</p>
</div>
<div class="section level2">
<h2 id="basic-requirements">Basic requirements<a class="anchor" aria-label="anchor" href="#basic-requirements"></a>
</h2>
<p>This vignette assumes that you know the basics of R and have the following packages
already installed:</p>
<ul>
<li>ape: for phylogenetic trees;</li>
<li>akima: necessary for interpolation of data (used for the calculation of the
likelihood by the phydynR package);</li>
<li>
<a href="%22https://github.com/florianhartig/BayesianTools%22" class="external-link">BayesianTools</a>: package for
Bayesian inference;</li>
<li>CODA: is a series of tools to analze the output of Markov chain Monte Carlo;</li>
<li>devtools: useful for installing packages directly from github repository;</li>
<li>
<a href="%22https://github.com/emvolz-phylodynamics/phydynR%22" class="external-link">phydynR</a>: implements the
coalescent simulation and likelihood function for phylodynamic analysis;</li>
<li>
<a href="%22https://github.com/emvolz/treedater%22" class="external-link">treedater</a>: fits a molecular clock to
a phylogenetic tree.</li>
<li>
<a href="https://github.com/thednainus/senegalHIVmodel/tree/master" class="external-link">senegalHIVmodel</a>: contains the example data to run the analysis described in this tutorial.</li>
</ul>
<div class="section level3">
<h3 id="load-the-necessary-packages">Load the necessary packages:<a class="anchor" aria-label="anchor" href="#load-the-necessary-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/emmanuelparadis/ape" class="external-link">ape</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">akima</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/florianhartig/BayesianTools" class="external-link">BayesianTools</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://emvolz-phylodynamics.github.io/phydynR/">phydynR</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">treedater</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">senegalHIVmodel</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-model">The Model<a class="anchor" aria-label="anchor" href="#the-model"></a>
</h2>
<p>The model we fit is based on the structured coalescent models <span class="citation">(Volz 2012)</span>. These
models are used to estimate epidemiological parameters using a phylogenetic tree
and information on states of each tip of the tree. These states are discrete-trait
information representing each sequences.</p>
<p>In our mathematical model we have 4 different discrete-traits associated to each
genetic sequence:</p>
<ul>
<li>
<span class="math inline">\(gpf\)</span> = HIV sample from the general population – females;</li>
<li>
<span class="math inline">\(gpm\)</span> = HIV sample from the general population – males;</li>
<li>
<span class="math inline">\(msm\)</span> = HIV sample from men that have sex with other men;</li>
<li>
<span class="math inline">\(src\)</span> = source sample, which are HIV samples from individuals who are from
other countries and not from Senegal.</li>
</ul>
<div class="section level3">
<h3 id="stage-of-infection">Stage of infection<a class="anchor" aria-label="anchor" href="#stage-of-infection"></a>
</h3>
<p>We fit the HIV epidemic in Senegal using ordinary differential equations (ODE)
and only 1 stage of infection. This means that infected individuals would die
and not recover from the infection. In our model we represented it as <span class="math inline">\(\gamma\)</span>
rate. We used 1 stage of infection, because the metadata available for the
Senegal sequences did not have information that we could use to determine the
stage of HIV infection at the time the samples were collected.</p>
</div>
<div class="section level3">
<h3 id="how-transmissions-were-modelled">How transmissions were modelled?<a class="anchor" aria-label="anchor" href="#how-transmissions-were-modelled"></a>
</h3>
<ul>
<li>An infected <span class="math inline">\(msm\)</span> (<span class="math inline">\(I_{msm}\)</span>) could transmit to another <span class="math inline">\(msm\)</span> with
probability <span class="math inline">\(p_{msm2msm}\)</span>
</li>
<li>An infected <span class="math inline">\(msm\)</span> (<span class="math inline">\(I_{msm}\)</span>) could transmit to a <span class="math inline">\(gpf\)</span> with probability
<span class="math inline">\((1 - p_{msm2msm})\)</span>
</li>
<li>An infected <span class="math inline">\(gpf\)</span> (<span class="math inline">\(I_{gpf}\)</span>) could transmit to a <span class="math inline">\(gpm\)</span> with probability
<span class="math inline">\(p_{gpf2gpm}\)</span>
</li>
<li>An infected <span class="math inline">\(gpf\)</span> (<span class="math inline">\(I_{gpf}\)</span>) could transmit to a <span class="math inline">\(msm\)</span> with probability
<span class="math inline">\((1 - p_{gpf2gpm})\)</span>
</li>
<li>An infected <span class="math inline">\(gpm\)</span> could also transmit to a <span class="math inline">\(gpf\)</span>. For this event, we used the
risk ratio of a male to transmit to a female, and fixed it to <span class="math inline">\(1.02\)</span>. This is the
parameter <span class="math inline">\(male_{x}\)</span> of our model.</li>
</ul>
<p>See Figure <a href="#fig:figure1">1</a> for a schematic representation of the transmission
model for HIV in Senegal. In this figure <span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span> and <span class="math inline">\(msm\)</span> represent the
infected individuals.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:figure1"></span>
<img src="../articles/figures/SN_model_v2.png" alt="Transmission model for HIV in Senegal. $gpf$, $gpm$ and $msm$ represent infected individuals." width="100%"><p class="caption">
Figure 1: Transmission model for HIV in Senegal. <span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span> and <span class="math inline">\(msm\)</span> represent infected individuals.
</p>
</div>
</div>
<div class="section level3">
<h3 id="how-about-hiv-incidence-rate">How about HIV incidence rate?<a class="anchor" aria-label="anchor" href="#how-about-hiv-incidence-rate"></a>
</h3>
<p>We also modeled the HIV incidence rate as a function of time (<span class="math inline">\(t\)</span>) in <span class="math inline">\(msm\)</span> and
the <span class="math inline">\(gp\)</span> (general population) as different spline functions <span class="citation">(Eilers and Marx 1996)</span>, that
in our ODEs are represented by <span class="math inline">\(\lambda(t)\)</span> and <span class="math inline">\(\mu(t)\)</span>, respectively.</p>
</div>
<div class="section level3">
<h3 id="the-source-compartment">The <span class="math inline">\(source\)</span> compartment<a class="anchor" aria-label="anchor" href="#the-source-compartment"></a>
</h3>
<p>Finally, to model the HIV epidemic in Senegal, we also added an additional
compartment named “source” (<span class="math inline">\(src\)</span>), that represents the rate in which HIV lineages
are imported to Senegal from other countries. We modeled this as a constant
effective population size rate with two parameters to be estimated – <span class="math inline">\(srcNe\)</span>:
the effective source population size; and the <span class="math inline">\(import\)</span> rate. Because the number
of imported HIV balances the number of exported HIV, the infected <span class="math inline">\(src\)</span>
individuals along time are not represented in the ODEs.</p>
</div>
<div class="section level3">
<h3 id="the-odes-or-mathematical-model-equations">The ODEs or mathematical model equations<a class="anchor" aria-label="anchor" href="#the-odes-or-mathematical-model-equations"></a>
</h3>
<p>Based on <strong>Figure <a href="#fig:figure1">1</a></strong> and the parameters we would like to estimate,
the ordinary differential equations (ODEs) of our model are:</p>
<p><span class="math inline">\(\dot{I}_{gpf} = male_x \mu(t) I_{gpm} + (1 - p_{msm2msm}) \lambda(t) I_{msm} - \gamma I_{gpf}\)</span></p>
<p><span class="math inline">\(\dot{I}_{gpm} = p_{gpf2gpm} \mu(t) I_{gpf} - \gamma I_{gpm}\)</span></p>
<p><span class="math inline">\(\dot{I}_{msm} = (1 - p_{gpf2gpm}) \mu(t) I_{gpf} + p_{msm2msm} \lambda(t) I_{msm} - \gamma I_{msm}\)</span></p>
<p>For a publication, you should choose mathematical symbols such as <span class="math inline">\(\phi\)</span>, or <span class="math inline">\(p\)</span>,
etc to make your equations nicer. However, for simplicity and to make it easier
to understand the meaning of the parameters, we will keep the values as it is,
such as <span class="math inline">\(p_{gpf2gpm}\)</span>, etc.</p>
</div>
<div class="section level3">
<h3 id="how-to-express-the-mathematical-model-in-r">How to express the mathematical model in R?<a class="anchor" aria-label="anchor" href="#how-to-express-the-mathematical-model-in-r"></a>
</h3>
<p>In our model, we are interested in HIV transmissions in the <span class="math inline">\(gp\)</span> and in the <span class="math inline">\(msm\)</span>
risk group. But also remember that we have to consider the imported HIV, which
is in the <span class="math inline">\(src\)</span> compartment. Based on that, <span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span>, <span class="math inline">\(msm\)</span>, and <span class="math inline">\(src\)</span> are
the demes of our model, and are represented as a vector in R as:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gpm"</span>, <span class="st">"gpf"</span>, <span class="st">"msm"</span>, <span class="st">"src"</span><span class="op">)</span></span></code></pre></div>
<p>Because we use spline functions to determine the shape of the curve for the
transmission rates in <span class="math inline">\(gp\)</span> and <span class="math inline">\(msm\)</span>, we should provide the initial <code>T0</code> and
final <code>T1</code> times for our simulations.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">T0</span> <span class="op">&lt;-</span> <span class="fl">1978</span></span>
<span><span class="va">T1</span> <span class="op">&lt;-</span> <span class="fl">2014</span></span></code></pre></div>
<p>We can also go ahead and set the value for the stage of infection, that in our
model is just one stage. We assume we know this value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GAMMA</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span></span></code></pre></div>
<p>We should also create a list to set up a template for the parameter values of
our model. You can set this to values that you think are appropriate. Remember
that the majority of parameter values in this list will be estimated.
In R, this list of parameter values can be created as below:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">THETA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  gpsp0 <span class="op">=</span> <span class="fl">6</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>  gpsp1 <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>  gpsp2 <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>  gpsploc <span class="op">=</span> <span class="fl">1987</span>,</span>
<span>  msmsp0 <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>  msmsp1 <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>  msmsp2 <span class="op">=</span> <span class="fl">2</span><span class="op">/</span><span class="fl">10</span>,</span>
<span>  msmsploc <span class="op">=</span> <span class="fl">1995</span>,</span>
<span>  maleX <span class="op">=</span> <span class="fl">1.02</span>,</span>
<span>  import <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">20</span>,</span>
<span>  srcNe <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  gpspline <span class="op">=</span> <span class="kw">function</span><span class="op">(</span> <span class="va">t</span>, <span class="va">parms</span> <span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="va">T0</span> <span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="va">parms</span><span class="op">$</span><span class="va">gpsp0</span> <span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&gt;</span> <span class="va">T1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">parms</span><span class="op">$</span><span class="va">gpsp2</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">parms</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span> x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">T0</span>, <span class="va">gpsploc</span>, <span class="va">T1</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gpsp0</span>, <span class="va">gpsp1</span>, <span class="va">gpsp2</span><span class="op">)</span> , xout <span class="op">=</span> <span class="va">t</span>, rule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  msmspline  <span class="op">=</span> <span class="kw">function</span><span class="op">(</span> <span class="va">t</span>, <span class="va">parms</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="va">T0</span> <span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="va">parms</span><span class="op">$</span><span class="va">msmsp0</span> <span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&gt;</span> <span class="va">T1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span> <span class="va">parms</span><span class="op">$</span><span class="va">msmsp2</span> <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">parms</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span> x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">T0</span>, <span class="va">msmsploc</span>, <span class="va">T1</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">msmsp0</span>, <span class="va">msmsp1</span>, <span class="va">msmsp2</span><span class="op">)</span> , xout <span class="op">=</span> <span class="va">t</span>, rule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  pmsm2msm <span class="op">=</span> <span class="fl">0.85</span>, </span>
<span>  pgpf2gpm <span class="op">=</span> <span class="fl">0.85</span>,</span>
<span>  initmsm <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  initgp <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that parameters <span class="math inline">\(gpsp0\)</span>, <span class="math inline">\(gpsp1\)</span>, <span class="math inline">\(gpsp2\)</span>, and <span class="math inline">\(gpsploc\)</span> are necessary to
estimate the flexible piecewise linear function for the <span class="math inline">\(gp\)</span> (<span class="math inline">\(gpspline\)</span> in R
or <span class="math inline">\(\mu(t)\)</span> in the ODEs).
And parameters <span class="math inline">\(msmsp0\)</span>, <span class="math inline">\(msmsp1\)</span>, <span class="math inline">\(msmsp2\)</span>, <span class="math inline">\(msmsploc\)</span> are necessary to
estimate the flexible piecewise linear function for the <span class="math inline">\(msm\)</span> risk group
(<span class="math inline">\(msmspline\)</span> in R or <span class="math inline">\(\lambda(t)\)</span> in the ODEs).</p>
<table class="table table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-6">Table 1: </span>Parameter definition, values and symbols used in the R script.
</caption>
<thead><tr>
<th style="text-align:left;">
Parameter
</th>
<th style="text-align:left;">
Symbol in R
</th>
<th style="text-align:left;">
Initial values
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Transmission rate gp0
</td>
<td style="text-align:left;">
gpsp0
</td>
<td style="text-align:left;">
6/10
</td>
</tr>
<tr>
<td style="text-align:left;">
Transmission rate gp1
</td>
<td style="text-align:left;">
gpsp1
</td>
<td style="text-align:left;">
4/10
</td>
</tr>
<tr>
<td style="text-align:left;">
Transmission rate gp2
</td>
<td style="text-align:left;">
gpsp2
</td>
<td style="text-align:left;">
1/10
</td>
</tr>
<tr>
<td style="text-align:left;">
Time interval for gp
</td>
<td style="text-align:left;">
gpsploc
</td>
<td style="text-align:left;">
1987
</td>
</tr>
<tr>
<td style="text-align:left;">
Transmission rate msm0
</td>
<td style="text-align:left;">
msmsp0
</td>
<td style="text-align:left;">
4/10
</td>
</tr>
<tr>
<td style="text-align:left;">
Transmission rate msm1
</td>
<td style="text-align:left;">
msmsp1
</td>
<td style="text-align:left;">
4/10
</td>
</tr>
<tr>
<td style="text-align:left;">
Transmission rate msm2
</td>
<td style="text-align:left;">
msmsp2
</td>
<td style="text-align:left;">
2/10
</td>
</tr>
<tr>
<td style="text-align:left;">
Time interval for msm
</td>
<td style="text-align:left;">
msmsploc
</td>
<td style="text-align:left;">
1995
</td>
</tr>
<tr>
<td style="text-align:left;">
Infectiouness ratio from male to female
</td>
<td style="text-align:left;">
maleX
</td>
<td style="text-align:left;">
1.2
</td>
</tr>
<tr>
<td style="text-align:left;">
Importation rate
</td>
<td style="text-align:left;">
import
</td>
<td style="text-align:left;">
1.20
</td>
</tr>
<tr>
<td style="text-align:left;">
Effective population size of src
</td>
<td style="text-align:left;">
srcNe
</td>
<td style="text-align:left;">
1.10
</td>
</tr>
<tr>
<td style="text-align:left;">
Probability of infected msm to infect another msm
</td>
<td style="text-align:left;">
pmsm2msm
</td>
<td style="text-align:left;">
0.85
</td>
</tr>
<tr>
<td style="text-align:left;">
Probability of infected gpf to infect a gpm
</td>
<td style="text-align:left;">
pgpf2gpm
</td>
<td style="text-align:left;">
0.85
</td>
</tr>
<tr>
<td style="text-align:left;">
Initial number of infected msm
</td>
<td style="text-align:left;">
initmsm
</td>
<td style="text-align:left;">
1.0
</td>
</tr>
<tr>
<td style="text-align:left;">
Initial number of infected gp
</td>
<td style="text-align:left;">
initgp
</td>
<td style="text-align:left;">
1.0
</td>
</tr>
</tbody>
</table>
<p>We also need to setup some initial conditions of our model. We should set an
arbitrary large number for the <span class="math inline">\(src\)</span> population.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SRCSIZE</span> <span class="op">&lt;&lt;-</span> <span class="fl">1e5</span></span>
<span><span class="va">X0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>gpm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">$</span><span class="va">initgp</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>        gpf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">$</span><span class="va">initgp</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>        msm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">$</span><span class="va">initmsm</span><span class="op">)</span>,</span>
<span>        src <span class="op">=</span> <span class="va">SRCSIZE</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="setting-up-the-birth-migration-and-death-rates">Setting up the birth, migration and death rates<a class="anchor" aria-label="anchor" href="#setting-up-the-birth-migration-and-death-rates"></a>
</h4>
<p>The calculation of births and migrations of our model are expressed as
4 <span class="math inline">\(\times\)</span> 4 matrices, which represent a transmission or movement from one deme
to another deme. Lineages also die at a same rate.</p>
<p>First, we have to setup the components of the model. This can be done using the <code>setup.model.equations</code> function in this research compendium.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eqns</span> <span class="op">&lt;-</span> <span class="fu">senegalHIVmodel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/senegalHIVmodel/man/setup.model.equations.html" class="external-link">setup.model.equations</a></span><span class="op">(</span><span class="va">demes</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/attach.html" class="external-link">attach</a></span><span class="op">(</span><span class="va">eqns</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="setting-up-the-birth-matrix">Setting up the birth matrix<a class="anchor" aria-label="anchor" href="#setting-up-the-birth-matrix"></a>
</h4>
<p>We should set up the birth matrix to allow transmissions from one deme to
another deme as in <strong>Figure <a href="#fig:figure1">1</a> </strong>.</p>
<table class="table table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-9">Table 2: </span>Illustration of allowed transmissions between demes.
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
gpm
</th>
<th style="text-align:left;">
gpf
</th>
<th style="text-align:left;">
msm
</th>
<th style="text-align:left;">
src
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
gpm
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(gpm \to gpf\)</span>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
</tr>
<tr>
<td style="text-align:left;">
gpf
</td>
<td style="text-align:left;">
<span class="math inline">\(gpf \to gpm\)</span>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(gpf \to msm\)</span>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
</tr>
<tr>
<td style="text-align:left;">
msm
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(msm \to gpf\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(msm \to msm\)</span>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
</tr>
<tr>
<td style="text-align:left;">
src
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(src \to src\)</span>
</td>
</tr>
</tbody>
</table>
<p>To set up these transmissions between demes, each element in the matrix is a
string that will be passed as R code.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births</span><span class="op">[</span><span class="st">'msm'</span>, <span class="st">'msm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$msmspline(t, parms) * msm * parms$pmsm2msm"</span></span>
<span><span class="va">births</span><span class="op">[</span><span class="st">'msm'</span>, <span class="st">'gpf'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$msmspline(t, parms) * msm * (1-parms$pmsm2msm)"</span></span>
<span></span>
<span><span class="va">births</span><span class="op">[</span><span class="st">'gpm'</span>, <span class="st">'gpf'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$gpspline(t, parms) * gpm * parms$maleX"</span></span>
<span><span class="va">births</span><span class="op">[</span><span class="st">'gpf'</span>, <span class="st">'gpm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$gpspline(t, parms) * gpf * parms$pgpf2gpm"</span></span>
<span><span class="va">births</span><span class="op">[</span><span class="st">'gpf'</span>, <span class="st">'msm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$gpspline(t, parms) * gpf * (1-parms$pgpf2gpm)"</span></span>
<span></span>
<span><span class="co"># f = (1/2)*(Y^2)/Ne</span></span>
<span><span class="va">births</span><span class="op">[</span><span class="st">'src'</span>, <span class="st">'src'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"0.5 * SRCSIZE^2 / parms$srcNe"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="setting-up-the-migration-matrix">Setting up the migration matrix<a class="anchor" aria-label="anchor" href="#setting-up-the-migration-matrix"></a>
</h4>
<p>Similar to the birth matrix, we also allow migrations from <span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span>, or <span class="math inline">\(msm\)</span>
to the <span class="math inline">\(src\)</span>; and from <span class="math inline">\(src\)</span> to <span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span>, or <span class="math inline">\(msm\)</span>. This is modelled as
a constant effective population size.</p>
<table class="table table table-striped table-hover" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-11">Table 3: </span>Illustration of allowed migrations between demes.
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
gpm
</th>
<th style="text-align:left;">
gpf
</th>
<th style="text-align:left;">
msm
</th>
<th style="text-align:left;">
src
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
gpm
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(gpm \to src\)</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
gpf
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(gpf \to src\)</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
msm
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
<td style="text-align:left;">
<span class="math inline">\(msm \to src\)</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
src
</td>
<td style="text-align:left;">
<span class="math inline">\(src \to gpm\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(src \to gpf\)</span>
</td>
<td style="text-align:left;">
<span class="math inline">\(src \to msm\)</span>
</td>
<td style="text-align:left;">
<ol start="0" style="list-style-type: decimal"><li></ol>
</td>
</tr>
</tbody>
</table>
<p>We also set up migrations between demes where each element in the matrix is a
string that will be passed as R code.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">migs</span><span class="op">[</span><span class="st">'src'</span>, <span class="st">'gpm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$import * gpm"</span></span>
<span><span class="va">migs</span><span class="op">[</span><span class="st">'src'</span>, <span class="st">'gpf'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$import * gpf"</span></span>
<span><span class="va">migs</span><span class="op">[</span><span class="st">'src'</span>, <span class="st">'msm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$import * msm"</span></span>
<span></span>
<span><span class="va">migs</span><span class="op">[</span><span class="st">'gpm'</span>, <span class="st">'src'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$import * gpm"</span></span>
<span><span class="va">migs</span><span class="op">[</span><span class="st">'gpf'</span>, <span class="st">'src'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$import * gpf"</span></span>
<span><span class="va">migs</span><span class="op">[</span><span class="st">'msm'</span>, <span class="st">'src'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"parms$import * msm"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="setting-up-the-vector-for-the-death-rates">Setting up the vector for the death rates<a class="anchor" aria-label="anchor" href="#setting-up-the-vector-for-the-death-rates"></a>
</h4>
<p>Similarly to the birth and migration matrices, we also set up death rates where
each element is a string that will be passed as R code.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">deaths</span><span class="op">[</span><span class="st">'msm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"GAMMA * msm"</span></span>
<span><span class="va">deaths</span><span class="op">[</span><span class="st">'gpf'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"GAMMA * gpf"</span></span>
<span><span class="va">deaths</span><span class="op">[</span><span class="st">'gpm'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"GAMMA * gpm"</span></span>
<span><span class="va">deaths</span><span class="op">[</span><span class="st">'src'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"0.5 * SRCSIZE^2 / parms$srcNe"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-demographic-model">The demographic model<a class="anchor" aria-label="anchor" href="#the-demographic-model"></a>
</h4>
<p>After setting up all the components of the mathematical model, we can build the
demographic process using the function <code>build.demographic.process</code> from the
<code>phydynR</code> package. The <code>dm</code> output can be used as input to coalescent models
for the calculation of the likelihood, when fitting the model using a
Markov chain Monte Carlo (MCMC), for example.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build.demographic.process.html">build.demographic.process</a></span><span class="op">(</span>births <span class="op">=</span> <span class="va">births</span>,</span>
<span>                                deaths <span class="op">=</span> <span class="va">deaths</span>,</span>
<span>                                migrations <span class="op">=</span> <span class="va">migs</span>,</span>
<span>                                parameterNames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">)</span>,</span>
<span>                                rcpp <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                sde <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>For more information on the the input data for the <code>build.demographic.process</code>
function, you should see its R documentation using the command
<code><a href="../reference/build.demographic.process.html">?phydynR::build.demographic.process</a></code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="load-additional-data">Load additional data<a class="anchor" aria-label="anchor" href="#load-additional-data"></a>
</h3>
<p>After setting up all the equations of the model in a way that R can understand,
the model can now be fitted to a binary and dated phylogenetic tree. In our
specific case, we estimated a maximum likelihood trees using
<a href="https://github.com/amkozlov/raxml-ng" class="external-link">RAxML-NG</a> for each subtype, as we analyzed
HIV-1 subtypes B, C and 02_AG.</p>
<p>Each tree had a relaxed clock fitted using the R package <a href="https://github.com/emvolz/treedater" class="external-link">treedater</a>. After that, the trees were merged
into a single tree using the R script <a href="https://github.com/thednainus/senegalHIVmodel/blob/master/analyses/scripts/R-scripts/Processing/merge_trees.R" class="external-link"><em>merge_trees.R</em></a>. The final tree did not contain sequences from children,
and from which risk group or sex was NA (not available).</p>
<p>We load the binary dated tree in R using the following:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">read.tree</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"data/bindTree_CGR_GTR+Gp12+3_droppedTip.tre"</span>, </span>
<span>  package <span class="op">=</span> <span class="st">"senegalHIVmodel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>After, we should load all the information for the metadata. This aims to create
a discrete-trait data for all tips in the phylogenetic tree. Remember that our discrete-trait data in this model are the <em>gpf</em>, <em>gpm</em>, <em>msm</em>, and <em>src</em>.</p>
<p>First we need to read in R all metadata as below:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Metadata that will be used in our model for the CGR (close global reference) </span></span>
<span><span class="co"># sequences and for sequences from Senegal.</span></span>
<span><span class="co"># CGRs are referred in the mathematical model as src (source) data</span></span>
<span><span class="co"># src are HIV sequences that are from other countries and not from Senegal</span></span>
<span></span>
<span><span class="co"># the 1st column is the sequence names</span></span>
<span><span class="co"># the 2nd column is the state (gpf, gpm, msm, or src) of each sequence</span></span>
<span><span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"data/states.RDS"</span>, package <span class="op">=</span> <span class="st">"senegalHIVmodel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>After organizing all metadata, we further organize it in a way that the R package <code>phydynR</code> will understand it.
For that, we create a matrix to receive the information on states (discrete-traits) for each tip of the tree</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gpm</span> <span class="op">&lt;-</span> <span class="va">gpf</span> <span class="op">&lt;-</span> <span class="va">msm</span> <span class="op">&lt;-</span> <span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tree.all</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Adds 1 to where states matches "gpm", and so on.</span></span>
<span><span class="va">gpm</span><span class="op">[</span><span class="va">all_data</span><span class="op">$</span><span class="va">States</span> <span class="op">==</span> <span class="st">"gpm"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">gpf</span><span class="op">[</span><span class="va">all_data</span><span class="op">$</span><span class="va">States</span> <span class="op">==</span> <span class="st">"gpf"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">msm</span><span class="op">[</span><span class="va">all_data</span><span class="op">$</span><span class="va">States</span> <span class="op">==</span> <span class="st">"msm"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">src</span><span class="op">[</span><span class="va">all_data</span><span class="op">$</span><span class="va">States</span> <span class="op">==</span> <span class="st">"src"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">sampleStates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">gpm</span>, <span class="va">gpf</span>, <span class="va">msm</span>, <span class="va">src</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sampleStates</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">all_data</span><span class="op">$</span><span class="va">tip.name</span></span></code></pre></div>
<p>Now, we need to read the estimated times (in calendar units) for each sequence
in the phylogenetic tree</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"data/bindTree_CGR_GTR+Gp12+3_droppedTip_sts.RDS"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"senegalHIVmodel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can create an an object of <code>DatedTree</code> [phydynR package]. This is
the tree that should be used in the calculation of the likelihood to estimate
parameter values using <code>phydynR</code></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dated.tree</span> <span class="op">&lt;-</span> <span class="fu">phydynR</span><span class="fu">::</span><span class="fu"><a href="../reference/DatedTree.html">DatedTree</a></span><span class="op">(</span>phylo <span class="op">=</span> <span class="va">tree.all</span>,</span>
<span>                                 sampleTimes <span class="op">=</span> <span class="va">times</span>,</span>
<span>                                 sampleStates <span class="op">=</span> <span class="va">sampleStates</span>,</span>
<span>                                 minEdgeLength <span class="op">=</span> <span class="fl">2</span><span class="op">/</span><span class="fl">52</span>,</span>
<span>                                 tol <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="calculation-of-the-likelihood">Calculation of the likelihood<a class="anchor" aria-label="anchor" href="#calculation-of-the-likelihood"></a>
</h2>
<p>After setting up the mathematical model and the data, we have the following:</p>
<ul>
<li>
<code>dated.tree</code> = a phylogenetic tree of class DatedTree</li>
<li>
<code>THETA</code> = template for parameter values</li>
<li>
<code>dm</code> = the demographic process</li>
<li>
<code>X0</code> = initial conditions</li>
</ul>
<p>The above objects will be used in the calculation of the likelihood using the
<code><a href="../reference/colik.html">phydynR::colik</a></code> function.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">phydynR</span><span class="fu">::</span><span class="fu"><a href="../reference/colik.html">colik</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">dated.tree</span>,</span>
<span>               theta <span class="op">=</span> <span class="va">THETA</span>,</span>
<span>               demographic.process.model <span class="op">=</span> <span class="va">dm</span>,</span>
<span>               x0 <span class="op">=</span> <span class="va">X0</span>,</span>
<span>               t0 <span class="op">=</span> <span class="fl">1978</span>,</span>
<span>               res <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>               timeOfOriginBoundaryCondition <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               AgtY_penalty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>               maxHeight <span class="op">=</span> <span class="fl">35</span><span class="op">)</span></span></code></pre></div>
<p>Note that for the calculation of the likelihood you can provide a value for
maximum height <code>maxHeight</code>. This parameter “tells” the function up to which point
back in time the calculation of the likelihood should be done. If computer
resources are not a problem, you can leave this as the default. Using the
whole tree for the calculation of the likelihood can make it slower than
when using just a portion back in time.</p>
<p>For the Senegal data, we used a <code>maxHeight</code> = 35. This means that it will go back
in time in the tree at approximately 1979. This was merely chosen to put the
HIV epidemics in Senegal around this time, for estimation of the parameters in
our model.</p>
</div>
<div class="section level2">
<h2 id="estimation-of-epidemiological-parameters">Estimation of epidemiological parameters<a class="anchor" aria-label="anchor" href="#estimation-of-epidemiological-parameters"></a>
</h2>
<p>Now that we are happy with everything, we are ready to estimate the parameters of
our model. For the Senegal HIV model, we chose to estimate the parameters using a
Markov chain Monte Carlo (MCMC) as implemented in the R package <a href="%22https://github.com/florianhartig/BayesianTools%22" class="external-link">BayesianTools</a>.</p>
<div class="section level3">
<h3 id="which-parameters-to-estimate">Which parameters to estimate?<a class="anchor" aria-label="anchor" href="#which-parameters-to-estimate"></a>
</h3>
<p>For this example, we decided to estimate the following parameters:</p>
<p><strong>Parameters for estimating the spline function for the <em>gp</em>:</strong></p>
<ul>
<li><em>gpsp0</em></li>
<li><em>gpsp1</em></li>
<li><em>gpsp2</em></li>
<li><em>gpsploc</em></li>
</ul>
<p><strong>Parameters for estimating the spline function for the <em>msm</em>:</strong></p>
<ul>
<li><em>msmsp0</em></li>
<li><em>msmsp1</em></li>
<li><em>msmsp2</em></li>
<li><em>msmsploc</em></li>
</ul>
<p><strong>Parameters that controls the <em>src</em>:</strong></p>
<ul>
<li><em>import</em></li>
<li><em>srcNe</em></li>
</ul>
<p><strong>Probability of certain events to occur:</strong></p>
<ul>
<li><em>pmsm2msm</em></li>
<li><em>pgpf2gpm</em></li>
<li><em>maleX</em></li>
</ul>
<p><strong>Parameters to estimate the initial population size:</strong></p>
<ul>
<li>
<em>initmsm</em> (initial number of individuals in the <em>msm</em> population)</li>
<li>
<em>initgp</em> (initial number of individuals in the <em>gp</em> population)</li>
</ul>
</div>
<div class="section level3">
<h3 id="estimating-the-parameters">Estimating the parameters<a class="anchor" aria-label="anchor" href="#estimating-the-parameters"></a>
</h3>
<p>To estimate these parameters we should set up an object function. This object
function will receive the proposals of the MCMC. The reason of using an object
function is to make it easier to change the values of the parameters to be estimated
in THETA (our parameter template as explained before). Note that not all
parameters listed in THETA will be estimated; some will stay fixed to the
predifined values.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># we use unname here because "parameters" can be as vectors or matrix, and</span></span>
<span>  <span class="co"># sometimes it comes with column names, which I chose to remove these column names</span></span>
<span>  <span class="co"># in here.</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># add the values of THETA to a new variable named THETA.new</span></span>
<span>  <span class="va">THETA.new</span> <span class="op">&lt;-</span> <span class="va">THETA</span></span>
<span></span>
<span>  <span class="co"># change the values in THETA.new to the new proposals that will be evaluated</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">gpsp0</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">gpsp1</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">gpsp2</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">gpsploc</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">msmsp0</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">msmsp1</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">msmsp2</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">msmsploc</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">maleX</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">import</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">srcNe</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">pmsm2msm</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">pgpf2gpm</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">13</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">initmsm</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">14</span><span class="op">]</span></span>
<span>  <span class="va">THETA.new</span><span class="op">$</span><span class="va">initgp</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[</span><span class="fl">15</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># X0 is the initial conditions for the 4 demes (gpf, gpm, msm, src)</span></span>
<span>  <span class="va">X0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>gpm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">THETA.new</span><span class="op">$</span><span class="va">initgp</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>          gpf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">THETA.new</span><span class="op">$</span><span class="va">initgp</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>          msm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">THETA.new</span><span class="op">$</span><span class="va">initmsm</span><span class="op">)</span> ,</span>
<span>          src <span class="op">=</span> <span class="fl">1e5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># After changing the parameter values to the new proposals, a likelihood is</span></span>
<span>  <span class="co"># calculated with the function phydynR::colik.</span></span>
<span>  <span class="co"># Note that this function uses several global variables, such as, dated.tree, </span></span>
<span>  <span class="co"># dm, and X0</span></span>
<span>  <span class="va">mll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/colik.html">colik</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">dated.tree</span>,</span>
<span>               theta <span class="op">=</span> <span class="va">THETA.new</span>,</span>
<span>               demographic.process.model <span class="op">=</span> <span class="va">dm</span>,</span>
<span>               x0 <span class="op">=</span> <span class="va">X0</span>,</span>
<span>               t0 <span class="op">=</span> <span class="fl">1978</span>,</span>
<span>               res <span class="op">=</span> <span class="fl">1e3</span>, <span class="co">#TODO</span></span>
<span>               timeOfOriginBoundaryCondition <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               AgtY_penalty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>               maxHeight <span class="op">=</span> <span class="fl">35</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mll</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can now estimate these parameters using the MCMC. For that we need to decide
the priors – our best knowledge on the parameter value before the data is
analysed – on each parameter that will be estimated.</p>
<p>Because we are using the <code>BayesianTools</code> R package, we need to specify the density function (that represents our prior) for each parameter as below:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify a density function to be used in the </span></span>
<span><span class="co"># prior specification (see below)</span></span>
<span><span class="va">densities</span> <span class="op">&lt;-</span>  <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># d1 to d3 and d5 to d7 I am using a lognormal distribution with mean = R0 = 1.1 and sigma = 1</span></span>
<span>  <span class="co"># d4 and d8 uniform distribution between the start time and the most recent sample</span></span>
<span>  <span class="co"># d10 exponential distribution with mean around 30</span></span>
<span>  <span class="co"># d11 exponential distribution with mean around 1/100</span></span>
<span>  <span class="va">d1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#gpsp0</span></span>
<span>  <span class="va">d2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#gpsp1</span></span>
<span>  <span class="va">d3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#gpsp2</span></span>
<span>  <span class="va">d4</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">1978</span>, max <span class="op">=</span> <span class="fl">2014</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#gpsploc</span></span>
<span>  <span class="va">d5</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#msmsp0</span></span>
<span>  <span class="va">d6</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#msmsp1</span></span>
<span>  <span class="va">d7</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#msmsp2</span></span>
<span>  <span class="va">d8</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">1978</span>, max <span class="op">=</span> <span class="fl">2014</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#msmsploc</span></span>
<span>  <span class="va">d9</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0.5</span>, max <span class="op">=</span> <span class="fl">2.0</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#maleX</span></span>
<span>  <span class="va">d10</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, rate <span class="op">=</span> <span class="fl">30</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#import</span></span>
<span>  <span class="va">d11</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span>, rate <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">100</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#srcNe</span></span>
<span>  <span class="va">d12</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span>, shape1 <span class="op">=</span> <span class="fl">16</span>, shape2 <span class="op">=</span> <span class="fl">4</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#pmsm2msm</span></span>
<span>  <span class="va">d13</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">dbeta</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">13</span><span class="op">]</span>, shape1 <span class="op">=</span> <span class="fl">16</span>, shape2 <span class="op">=</span> <span class="fl">4</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#pgpf2gpm</span></span>
<span>  <span class="va">d14</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">14</span><span class="op">]</span>, rate <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#initmsm</span></span>
<span>  <span class="va">d15</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">dexp</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="fl">15</span><span class="op">]</span>, rate <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">#initgp</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">d1</span> <span class="op">+</span> <span class="va">d2</span> <span class="op">+</span> <span class="va">d3</span> <span class="op">+</span> <span class="va">d4</span> <span class="op">+</span> <span class="va">d5</span> <span class="op">+</span> <span class="va">d6</span> <span class="op">+</span> <span class="va">d7</span> <span class="op">+</span> <span class="va">d8</span> <span class="op">+</span> <span class="va">d9</span> <span class="op">+</span> <span class="va">d10</span> <span class="op">+</span> <span class="va">d11</span> <span class="op">+</span> <span class="va">d12</span> <span class="op">+</span> <span class="va">d13</span> <span class="op">+</span> <span class="va">d14</span> <span class="op">+</span> <span class="va">d15</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we can provide a sampler, which is optional, as described in the <code>BayesianTools</code> package, as below:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create sampling, this is optional. </span></span>
<span><span class="co"># However, if a sampler function is not provided, the user will have to provide</span></span>
<span><span class="co"># explicit starting values for for many of the MCMC sampler</span></span>
<span><span class="va">sampler</span> <span class="op">&lt;-</span>  <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">d1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">0.6</span><span class="op">)</span> <span class="co">#gpsp0</span></span>
<span>  <span class="va">d2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">0.4</span><span class="op">)</span> <span class="co">#gpsp1</span></span>
<span>  <span class="va">d3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">0.1</span><span class="op">)</span> <span class="co">#gpsp2</span></span>
<span>  <span class="va">d4</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">1985</span>, max <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span> <span class="co">#gpsploc</span></span>
<span>  <span class="va">d5</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">0.4</span><span class="op">)</span> <span class="co">#msmsp0</span></span>
<span>  <span class="va">d6</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">0.4</span><span class="op">)</span> <span class="co">#msmsp1</span></span>
<span>  <span class="va">d7</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">4</span>, rate <span class="op">=</span> <span class="fl">4</span><span class="op">/</span><span class="fl">0.2</span><span class="op">)</span> <span class="co">#msmsp2</span></span>
<span>  <span class="va">d8</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">1985</span>, max <span class="op">=</span> <span class="fl">2005</span><span class="op">)</span> <span class="co">#msmsploc</span></span>
<span>  <span class="va">d9</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, min <span class="op">=</span> <span class="fl">0.5</span>, max <span class="op">=</span> <span class="fl">2.0</span><span class="op">)</span> <span class="co">#maleX</span></span>
<span>  <span class="va">d10</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">40</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span> <span class="co">#import</span></span>
<span>  <span class="va">d11</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">5</span>, <span class="fl">1000</span><span class="op">)</span> <span class="co">#srcNe</span></span>
<span>  <span class="va">d12</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span>, shape1 <span class="op">=</span> <span class="fl">16</span>, shape2 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co">#pmsm2msm</span></span>
<span>  <span class="va">d13</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span>, shape1 <span class="op">=</span> <span class="fl">16</span>, shape2 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co">#pgpf2gpm</span></span>
<span>  <span class="va">d14</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span> <span class="co">#initmsm</span></span>
<span>  <span class="va">d15</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span> <span class="co">#initgp</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">d1</span>, <span class="va">d2</span>, <span class="va">d3</span>, <span class="va">d4</span>, <span class="va">d5</span>, <span class="va">d6</span>, <span class="va">d7</span>, <span class="va">d8</span>, <span class="va">d9</span>, <span class="va">d10</span>, <span class="va">d11</span>, <span class="va">d12</span>, <span class="va">d13</span>, <span class="va">d14</span>, <span class="va">d15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>After setting up the densities and sampler functions we can now set up our prior
by using the following:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create prior (necessary for the BayesianTools package)</span></span>
<span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createPrior.html" class="external-link">createPrior</a></span><span class="op">(</span>density <span class="op">=</span> <span class="va">densities</span>,</span>
<span>                     sampler <span class="op">=</span> <span class="va">sampler</span>,</span>
<span>                     lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">1978</span>, </span>
<span>                               <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">1978</span>, </span>
<span>                               <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2014</span>, </span>
<span>                               <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2014</span>, </span>
<span>                               <span class="fl">2</span>, <span class="fl">0.30</span>, <span class="fl">5000</span>, <span class="fl">1</span>, </span>
<span>                               <span class="fl">1</span>, <span class="fl">300</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We are now ready to estimate the parameter values using MCMC. We chose the
DEzs sampler. DEzs stands for Differential-Evolution MCMC zs and this is beyond
what will cover in this vignette. However, if you can check Ter Braak and Vrugt <span class="citation">(2008)</span> for more information.</p>
<p>First, we run a MCMC as below for ca. 10,000 iterations. After checking the traces and decided they are <em>ok</em>, we can use this initial run to provided a z-matrix as explained <a href="https://github.com/florianhartig/BayesianTools/issues/79" class="external-link">here</a>.</p>
<p>Note that it beyond the scope of this vignette to explain about Markov chain
Monte Carlo (MCMC), but you can read more in this other <a href="https://thednainus.wordpress.com/2017/03/08/part1-introduction/" class="external-link">tutorial</a>.</p>
<p>Note that that the iterations parameter will take a long time to run.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">settings</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">10000</span>, nrChains <span class="op">=</span> <span class="fl">1</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co"># Create bayesianSetup</span></span>
<span><span class="va">bayesianSetup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html" class="external-link">createBayesianSetup</a></span><span class="op">(</span>likelihood <span class="op">=</span> <span class="va">obj_fun</span> , prior <span class="op">=</span> <span class="va">prior</span><span class="op">)</span></span>
<span><span class="co"># you do not need to run this part as it will take a while to run</span></span>
<span><span class="co"># run the MCMC</span></span>
<span><span class="co">#out &lt;- BayesianTools::runMCMC(bayesianSetup = bayesianSetup, </span></span>
<span><span class="co">#                              sampler = "DEzs", </span></span>
<span><span class="co">#                              settings = settings)</span></span></code></pre></div>
<p>Now we can use the results obtained with the previous run and create another
run but this time providing a Zmatrix as below:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get an ok sample (the run above is not good, however it can provide a good Z matrix)</span></span>
<span><span class="co"># For more information on this: https://github.com/florianhartig/BayesianTools/issues/79</span></span>
<span></span>
<span><span class="co">#read previous run</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"data/MCMC_example/out_results.RDS"</span>, </span>
<span>                           package <span class="op">=</span> <span class="st">"senegalHIVmodel"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html" class="external-link">getSample</a></span><span class="op">(</span><span class="va">out</span>, start <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the range for the parameter estimates for the previous run</span></span>
<span><span class="va">rangePost</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, <span class="va">range</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#get unique values of x</span></span>
<span><span class="va">u_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#cretae new Z matrix based on previous run</span></span>
<span><span class="co"># now I am estimating 15 parameters (hence ncol=15)</span></span>
<span><span class="va">newZ</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1800</span>, <span class="va">rangePost</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">rangePost</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">15</span>, byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Because I will run several analysis in parallel, and to avoid the initial values to be identical</span></span>
<span><span class="co"># I will provide as argument position 1 (pos1), position 2 (pos2), and position 3 (pos3)</span></span>
<span><span class="co"># from the unique values of x (u_x)</span></span>
<span><span class="va">pos1</span> <span class="op">=</span> <span class="fl">72</span></span>
<span><span class="va">pos2</span> <span class="op">=</span> <span class="fl">73</span></span>
<span><span class="va">pos3</span> <span class="op">=</span> <span class="fl">74</span></span>
<span><span class="va">iter</span> <span class="op">=</span> <span class="fl">80000</span> <span class="co"># number of iterations</span></span>
<span><span class="va">settings</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="va">newZ</span>, </span>
<span>                startValue <span class="op">=</span>  <span class="va">u_x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pos1</span>, <span class="va">pos2</span>, <span class="va">pos3</span><span class="op">)</span>, <span class="op">]</span>, </span>
<span>                nrChains <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                iterations <span class="op">=</span> <span class="va">iter</span>, </span>
<span>                thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Create bayesianSetup</span></span>
<span><span class="co"># Here we will take advantage of the parallel option.</span></span>
<span><span class="co">#bayesianSetup &lt;- createBayesianSetup(likelihood = obj_fun, </span></span>
<span><span class="co">#                                     prior = prior, </span></span>
<span><span class="co">#                                     parallel = 3)</span></span>
<span></span>
<span><span class="co">#Note that this will take a while to run as well</span></span>
<span><span class="co">#outZ &lt;- runMCMC(bayesianSetup = bayesianSetup,  sampler = "DEzs", settings = settings )</span></span>
<span><span class="co">#stopParallel(bayesianSetup)</span></span></code></pre></div>
<p>The MCMC will take a while to run, so we will instead load the results:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">outZ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"data/MCMC_example/outZ_results.RDS"</span>,</span>
<span>                            package <span class="op">=</span> <span class="st">"senegalHIVmodel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the traces:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#par("mar")</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#here we will plot just the 4 initial parameters for the linear function</span></span>
<span><span class="co">#representing the transmission rates for the general population</span></span>
<span><span class="co">#save than upload figure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">outZ</span>, whichParameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="SenegalHIVmodel_files/figure-html/unnamed-chunk-28-1.png"><!-- --></p>
<p>We can remove the first initial 5,000 iter as burnin and get the ESS (effective
sample size). You can see that ESS values a greater than 200 for all parameters.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">out_sample</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html" class="external-link">getSample</a></span><span class="op">(</span><span class="va">outZ</span>, start <span class="op">=</span> <span class="fl">5000</span>, coda <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ESS value for all parameters</span></span>
<span><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/effectiveSize.html" class="external-link">effectiveSize</a></span><span class="op">(</span><span class="va">out_sample</span><span class="op">)</span></span>
<span><span class="co">#&gt;    par 1    par 2    par 3    par 4    par 5    par 6    par 7    par 8 </span></span>
<span><span class="co">#&gt; 788.3901 512.8582 609.3268 569.5006 478.9808 496.5276 498.5685 428.6407 </span></span>
<span><span class="co">#&gt;    par 9   par 10   par 11   par 12   par 13   par 14   par 15 </span></span>
<span><span class="co">#&gt; 737.4058 700.1792 692.8029 565.6878 575.4979 540.1259 634.3283</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimating-effective-number-of-infections">Estimating effective number of infections<a class="anchor" aria-label="anchor" href="#estimating-effective-number-of-infections"></a>
</h3>
<p>We can now estimate and plot the effective number of infections through time for
<span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span> and <span class="math inline">\(msm\)</span>.
For that, we will sample 100 combination of parameter values from the
posterior distribution. For the paper we published, we sampled 1000 combination
of parameter values.
Then for each combination of parameter values from the posterior distributions,
we will solve the demographic process <em>dm</em> function that we created in
the beginning to this tutorial.
We will use the function <em>post_traj_mx</em> from the R package <code>senegalHIVmodel</code>. If
you have a look at this function, you will see that we are solving dm for
each combination of parameter value from the posterior distribution.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">out_sample</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html" class="external-link">getSample</a></span><span class="op">(</span><span class="va">outZ</span>, start <span class="op">=</span> <span class="fl">5000</span>, coda <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># sample n combination of parameters from the posterior</span></span>
<span>  <span class="co"># here we will use only a size = 10 samples to make it faster to run</span></span>
<span>  <span class="co"># in the paper, we used size = 1,000 samples from the posterior probability</span></span>
<span>  <span class="va">run.n</span> <span class="op">&lt;-</span> <span class="va">out_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">out_sample</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># solve the demographic model for 100 combination of parameter values</span></span>
<span>  <span class="co"># that was sampled from the posterior probability</span></span>
<span>  <span class="va">run_o.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"cbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">run.n</span>, <span class="fl">1</span>, <span class="fu">senegalHIVmodel</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/senegalHIVmodel/man/post_traj_mx.html" class="external-link">post_traj_mx</a></span>, <span class="va">THETA</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now load the solved demographic process for 100 samples for the
posterior distribution. Note that in the paper, we used 1,000 samples from the
posterior distribution.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_o.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"data/solved_dm.RDS"</span>, package <span class="op">=</span> <span class="st">"senegalHIVmodel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, we can solve the demographic process function for the maximum a posteriori
(MAP).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span>  <span class="co">#then we will fo the same for the MAP (maximum a posteriori value)</span></span>
<span>  <span class="va">run_map</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/MAP.html" class="external-link">MAP</a></span><span class="op">(</span><span class="va">outZ</span>, start <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span><span class="op">$</span><span class="va">parametersMAP</span></span>
<span>  </span>
<span>  <span class="co"># solve the demographic model for MAP </span></span>
<span>  <span class="va">run_map_o</span> <span class="op">&lt;-</span> <span class="fu">senegalHIVmodel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/senegalHIVmodel/man/post_traj_mx.html" class="external-link">post_traj_mx</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">run_map</span>, THETA <span class="op">=</span> <span class="va">THETA</span><span class="op">)</span></span></code></pre></div>
<p>After solving the demographic model for each combination of parameter value,
we can use the function <em>senegalHIVmodel::df_sizes_prop</em> to get the proportion
of <span class="math inline">\(gpm\)</span>, <span class="math inline">\(gpf\)</span> and <span class="math inline">\(msm\)</span> for the effective population size, which is the 4th
element from the solved demographic process.
And then we can plot the proportion of <span class="math inline">\(gpf\)</span>, <span class="math inline">\(gpm\)</span> and <span class="math inline">\(msm\)</span>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note that the element 4 in the sizes in the solved demographic function</span></span>
<span><span class="va">eff_sizes</span> <span class="op">&lt;-</span> <span class="fu">senegalHIVmodel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/senegalHIVmodel/man/df_sizes_prop.html" class="external-link">df_sizes_prop</a></span><span class="op">(</span>sizes.p <span class="op">=</span> <span class="va">run_o.n</span><span class="op">[</span><span class="fl">4</span>,<span class="op">]</span>,</span>
<span>                                            sizes.map <span class="op">=</span> <span class="va">run_map_o</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>                                            times <span class="op">=</span> <span class="va">run_o.n</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                                            Nrep <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                            Ntime <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">eff_sizes</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">times</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, fill <span class="op">=</span> <span class="va">group</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.70</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">median</span>, colour <span class="op">=</span> <span class="va">group</span>, linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">MAP</span>, colour <span class="op">=</span> <span class="va">group</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">group</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"All subtypes"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Effective number of infections (proportion)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time (years)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_colour_brewer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span>, text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MAP'</span>, <span class="st">"Median"</span><span class="op">)</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dashed"</span>, <span class="st">"solid"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="SenegalHIVmodel_files/figure-html/unnamed-chunk-33-1.png"><!-- --></p>
</div>
<div class="section level3">
<h3 id="estimating-the-reproduction-number-r_0">Estimating the reproduction number (<span class="math inline">\(R_0\)</span>)<a class="anchor" aria-label="anchor" href="#estimating-the-reproduction-number-r_0"></a>
</h3>
<p>We can calculate the <span class="math inline">\((R_0)\)</span> for this model using the equations <span class="math inline">\(\mu(t)/\gamma\)</span>
for <span class="math inline">\(gp\)</span> and <span class="math inline">\(\lambda(t)/\gamma\)</span> for <span class="math inline">\(msm\)</span>.
Note that <span class="math inline">\(\mu(t)\)</span> and <span class="math inline">\(\lambda(t)\)</span> are the transmission rates through time
for <span class="math inline">\(gp\)</span> and <span class="math inline">\(msm\)</span>, respectively, and were estimated with MCMC.</p>
<p>We can then use the function <code><a href="https://rdrr.io/pkg/senegalHIVmodel/man/df_r0.html" class="external-link">senegalHIVmodel::df_r0</a></code>. This function will
basically estimate transmission rate for each group (<span class="math inline">\(gp\)</span> or <span class="math inline">\(msm\)</span>) by solving
the function <span class="math inline">\(\mu(t)\)</span> and <span class="math inline">\(\lambda(t)\)</span> as described in THETA (above).
Then it estimate the <span class="math inline">\((R_0)\)</span> as described above.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># These are the values used for the simulations</span></span>
<span><span class="co"># Initial time for simulations</span></span>
<span><span class="va">T0</span> <span class="op">&lt;-</span> <span class="fl">1978</span></span>
<span><span class="co"># Final time for simulations</span></span>
<span><span class="va">T1</span> <span class="op">&lt;-</span> <span class="fl">2014</span></span>
<span><span class="co"># Duration of infection. In our model we assumed 1 stage of infection</span></span>
<span><span class="va">GAMMA</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span></span>
<span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1978</span>, <span class="fl">2014</span>, length.out <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_subtypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/senegalHIVmodel/man/df_r0.html" class="external-link">df_r0</a></span><span class="op">(</span>run <span class="op">=</span> <span class="va">outZ</span>,</span>
<span>                      burnin <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                      par_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gpsp0"</span>, <span class="st">"gpsp1"</span>, <span class="st">"gpsp2"</span>, <span class="st">"gpsploc"</span>,</span>
<span>                                    <span class="st">"msmsp0"</span>, <span class="st">"msmsp1"</span>, <span class="st">"msmsp2"</span>, <span class="st">"msmsploc"</span>,</span>
<span>                                    <span class="st">"maleX"</span>, <span class="st">"import"</span>, <span class="st">"srcNe"</span>,</span>
<span>                                    <span class="st">"pmsm2msm"</span>, <span class="st">"pgpf2gpm"</span>,</span>
<span>                                    <span class="st">"initmsm"</span>, <span class="st">"initgp"</span><span class="op">)</span>,</span>
<span>                      times <span class="op">=</span> <span class="va">times</span>,</span>
<span>                      T0 <span class="op">=</span> <span class="va">T0</span>,</span>
<span>                      T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>                      GAMMA <span class="op">=</span> <span class="va">GAMMA</span><span class="op">)</span></span></code></pre></div>
<p>We can then look at the median and credible interval for the <span class="math inline">\(R_0\)</span> for <span class="math inline">\(gp\)</span> and
<span class="math inline">\(msm\)</span> in 2014.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#for gp</span></span>
<span><span class="va">all_subtypes</span><span class="op">[</span><span class="fl">1000</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;      times   median     lower    upper group MAP</span></span>
<span><span class="co">#&gt; 1000  2014 1.499884 0.8357501 2.444434    gp 1.4</span></span>
<span></span>
<span><span class="co">#for msm</span></span>
<span><span class="va">all_subtypes</span><span class="op">[</span><span class="fl">2000</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;      times   median     lower    upper group  MAP</span></span>
<span><span class="co">#&gt; 2000  2014 0.987994 0.5305526 2.142065   msm 0.59</span></span></code></pre></div>
<p>Note that the values obtained here might not match exactly as described in the
paper. This is because we tested many different models and run the MCMC for longer.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Eilers1996" class="csl-entry">
Eilers, Paul H C, and Brian D Marx. 1996. <span>“<span class="nocase">Flexible smoothing with B-splines and penalties</span>.”</span> <em>Statistical Science</em> 11 (2): 89–121. <a href="https://doi.org/10.1214/ss/1038425655" class="external-link">https://doi.org/10.1214/ss/1038425655</a>.
</div>
<div id="ref-TerBraak2008" class="csl-entry">
Ter Braak, Cajo J F, and Jasper A Vrugt. 2008. <span>“<span class="nocase">Differential Evolution Markov Chain with snooker updater and fewer chains</span>.”</span> <em>Statistics and Computing</em> 18 (4): 435–46. <a href="https://doi.org/10.1007/s11222-008-9104-9" class="external-link">https://doi.org/10.1007/s11222-008-9104-9</a>.
</div>
<div id="ref-Volz2012" class="csl-entry">
Volz, Erik M. 2012. <span>“<span class="nocase">Complex Population Dynamics and the Coalescent Under Neutrality</span>.”</span> <em>Genetics</em> 190 (1): 187–201. <a href="https://doi.org/10.1534/genetics.111.134627" class="external-link">https://doi.org/10.1534/genetics.111.134627</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Website developed by <a href="https://thednainus.wordpress.com/me/" class="external-link">Fabricia F. Nascimento</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
